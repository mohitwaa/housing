<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Property Filter</title>
  <!-- 
    ðŸš€ RELIABLE LOCAL PROXY SOLUTION:
    
    SETUP INSTRUCTIONS:
    1. Install Node.js if not already installed
    2. Run: npm install
    3. Run: npm start
    4. Open: http://localhost:3000/property_filter_wireframe.html
    
    This solution uses a local proxy server that's 100% reliable!
    No more CORS issues or unreliable external proxies.
  -->
  <style>
    :root{
      --primary:#4838a2;
      --secondary:#7b68ee;
      --text:#000;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card-bg:#fff;
    }
    body {
      font-family: 'Roboto Flex', sans-serif;
      background-color: #ffffff;
      color: var(--text);
      padding: 0;
      margin: 0;
    }
    .update-strip {
      background-color: var(--primary);
      color: white;
      text-align: center;
      padding: 14px 20px;
      font-size: 15px;
      font-weight: 500;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .update-strip a {
      color: #ffffff;
      text-decoration: none;
      background-color: rgba(255, 255, 255, 0.2);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      transition: background 0.3s ease;
    }
    .update-strip a:hover { background-color: rgba(255, 255, 255, 0.35); }

    .wrap{ max-width: 720px; margin: 32px auto; padding: 0 16px; }

    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      background: var(--card-bg);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .full{ grid-column: 1 / -1; }

    label { display:block; font-weight:600; font-size:14px; color:#111827; }
    .hint{ font-size:12px; color:var(--muted); margin-top:4px; }
    input[type="text"], input[type="number"] {
      width: 95%; padding: 10px 12px; margin-top: 8px; border: 1px solid #ccc;
      border-radius: 10px; font-size: 16px !important;
    }

    #locality, #bhk, #budgetMax {
      font-size: 16px !important;
    }

    /* Autocomplete dropdown styles */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 10px 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .autocomplete-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
      position: relative;
    }

    .autocomplete-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -1;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover {
      background-color: #f8f7ff;
    }

    .autocomplete-item.selected {
      background-color: var(--primary);
      color: white;
    }

    .autocomplete-item .name {
      font-weight: 500;
      font-size: 14px;
    }

    .autocomplete-item .type {
      display: none;
    }

    .loading {
      padding: 12px 16px;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .loading::before {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .no-results {
      padding: 12px 16px;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      font-style: italic;
    }

    .action-btn { margin-top: 12px; width: 100%; background-color: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s ease; }
    .action-btn:hover { background-color: #372b82; }

    /* Results */
    .results{ margin-top:24px; display:grid; grid-template-columns: 1fr; gap:16px; }
    .result-count{ background:#f8f7ff; border:1px solid var(--border); border-radius:14px; padding:16px; text-align:center; }
    .result-count .num{ font-size:32px; font-weight:800; color:var(--primary); }
    .sub{ font-size:13px; color:var(--muted); margin-top:4px; }

    .result-section{ border:1px solid var(--border); border-radius:14px; padding:16px; }
    .section-title{ font-size:14px; font-weight:700; color:#111827; margin-bottom:8px; }
    .pill{ display:inline-block; background:#eef2ff; color:var(--primary); border:1px solid #dfe3ff; padding:6px 10px; border-radius:999px; font-size:12px; margin:4px 6px 0 0; }

    .flex-row{ display:flex; gap:12px; flex-wrap:wrap; }
    .kv{ display:flex; flex-direction:column; background:#fafafa; border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:13px; margin-bottom:8px; }
    .kv strong{ color:#111827; margin-bottom:4px; }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="card">
      <div class="grid">
        <div class="full">
          <label for="locality">Locality</label>
          <div class="autocomplete-container">
            <input type="text" id="locality" placeholder="Enter locality" />
            <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
          </div>
        </div>

        <div>
          <label for="bhk">BHK (number)</label>
          <input type="number" id="bhk" min="1" max="6" step="1" placeholder="e.g., 2" />
          <div class="hint">Enter numeric BHK (1â€“6)</div>
        </div>

        <div class="full">
          <label for="budgetMin">Budget</label>
          <div style="display:flex; align-items:center; gap:8px;">
            <input type="number" id="budgetMax" placeholder="Max" />
          </div>
          <div class="hint">Enter maximum Bugdet Amount</div>
        </div>

        <div class="full">
          <button class="action-btn" onclick="checkCount()">Show Matches</button>
        </div>
      </div>

      <!-- Results -->
      <div class="results" id="results" style="display:none;">
        <div class="result-count">
          <div class="num" id="propCount">0</div>
          <div class="sub" id="summaryText">properties match your filters</div>
        </div>

        <div class="result-section" id="radiusSection" style="display: none;">
          <div class="section-title">Radius Expansion</div>
          <div class="kv"><strong>< 2 km</strong><span id="r2km">â€”</span><span id="r2kmCount">0 props</span></div>
          <div class="kv"><strong>< 5 km</strong><span id="r5km">â€”</span><span id="r5kmCount">0 props</span></div>
        </div>

        <div class="result-section" id="budgetFlex" style="display: none;">
          <div class="section-title">Budget Flexibility</div>
          <div class="flex-row">
            <span class="pill" id="inc2k">+â‚¹2k â†’ 0 props</span>
            <span class="pill" id="inc5k">+â‚¹5k â†’ 0 props</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Autocomplete functionality
    let debounceTimer;
    let selectedIndex = -1;
    let suggestions = [];
    let selectedLocality = null;
    let cache = new Map(); // Cache for API responses
    let isLoading = false;

    const localityInput = document.getElementById('locality');
    const dropdown = document.getElementById('autocompleteDropdown');

    // Debounce function to limit API calls
    function debounce(func, wait) {
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(debounceTimer);
          func(...args);
        };
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(later, wait);
      };
    }

    // Check if query is already cached
    function getCachedResults(query) {
      return cache.get(query.toLowerCase().trim());
    }

    // Cache the results
    function cacheResults(query, results) {
      cache.set(query.toLowerCase().trim(), results);
      // Limit cache size to prevent memory issues
      if (cache.size > 100) {
        const firstKey = cache.keys().next().value;
        cache.delete(firstKey);
      }
    }



    // Fetch suggestions from API
    async function fetchSuggestions(query) {
      if (!query || query.length < 2) {
        hideDropdown();
        return;
      }

      // Check cache first
      const cachedResults = getCachedResults(query);
      if (cachedResults) {
        suggestions = cachedResults;
        displaySuggestions(cachedResults);
        return;
      }

      // Prevent multiple simultaneous requests
      if (isLoading) {
        return;
      }

      isLoading = true;
      showLoading();

      try {
        const encodedQuery = encodeURIComponent(query);
        const url = `https://regions.housing.com/api/v1/polygon/suggest/?service_type=rent&feature_type=locality,sublocality,neighbourhood&input=${encodedQuery}`;
        
        // Use local proxy server for reliable requests
        const proxyUrl = `/api/proxy?url=${encodeURIComponent(url)}`;
        
        console.log('Using local proxy:', proxyUrl);
        
        const response = await fetch(proxyUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`Proxy request failed: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data) {
          throw new Error('No data received from proxy server.');
        }
        
        // Cache the results
        cacheResults(query, data);
        
        suggestions = data;
        displaySuggestions(data);
      } catch (error) {
        console.error('Error fetching suggestions:', error);
        showNoResults('Unable to fetch localities. Please try again.');
      } finally {
        isLoading = false;
      }
    }





    // Display suggestions in dropdown
    function displaySuggestions(data) {
      if (!data || data.length === 0) {
        showNoResults();
        return;
      }

      // Show all locality data from API
      const filteredData = data;

      if (filteredData.length === 0) {
        showNoResults();
        return;
      }

      dropdown.innerHTML = '';
      selectedIndex = -1;

      filteredData.forEach((item, index) => {
        const itemElement = document.createElement('div');
        itemElement.className = 'autocomplete-item';
        itemElement.dataset.index = index;
        
        itemElement.innerHTML = `
          <div class="name">${item.name}</div>
          <div class="type">${item.type} â€¢ ${item.super_type}</div>
        `;

        itemElement.addEventListener('click', () => selectItem(item));
        itemElement.addEventListener('mouseenter', () => {
          selectedIndex = index;
          updateSelection();
        });
        itemElement.addEventListener('mouseleave', () => {
          // Only clear selection if mouse leaves dropdown entirely
          if (!dropdown.matches(':hover')) {
            selectedIndex = -1;
            updateSelection();
          }
        });

        dropdown.appendChild(itemElement);
      });

      showDropdown();
    }

    // Show loading state
    function showLoading() {
      dropdown.innerHTML = '<div class="loading">Searching localities...</div>';
      showDropdown();
    }

    // Show no results
    function showNoResults(message = 'No localities found') {
      dropdown.innerHTML = `<div class="no-results">${message}</div>`;
      showDropdown();
    }

    // Show dropdown
    function showDropdown() {
      dropdown.style.display = 'block';
    }

    // Hide dropdown
    function hideDropdown() {
      dropdown.style.display = 'none';
      selectedIndex = -1;
    }

    // Select an item
    function selectItem(item) {
      localityInput.value = item.name;
      selectedLocality = item;
      hideDropdown();
    }

    // Update selection highlight
    function updateSelection() {
      const items = dropdown.querySelectorAll('.autocomplete-item');
      items.forEach((item, index) => {
        item.classList.toggle('selected', index === selectedIndex);
      });
    }

    // Handle keyboard navigation
    function handleKeydown(event) {
      const items = dropdown.querySelectorAll('.autocomplete-item');
      
      switch (event.key) {
        case 'ArrowDown':
          event.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          updateSelection();
          break;
        case 'ArrowUp':
          event.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelection();
          break;
        case 'Enter':
          event.preventDefault();
          if (selectedIndex >= 0 && suggestions[selectedIndex]) {
            selectItem(suggestions[selectedIndex]);
          }
          break;
        case 'Escape':
          hideDropdown();
          break;
      }
    }

    // Event listeners
    localityInput.addEventListener('input', debounce((e) => {
      fetchSuggestions(e.target.value);
    }, 500)); // Increased debounce time for better performance

    localityInput.addEventListener('keydown', handleKeydown);

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!localityInput.contains(e.target) && !dropdown.contains(e.target)) {
        hideDropdown();
      }
    });

    // Focus management
    localityInput.addEventListener('focus', () => {
      if (suggestions.length > 0) {
        showDropdown();
      }
    });

    // Dropdown hover management
    dropdown.addEventListener('mouseleave', () => {
      selectedIndex = -1;
      updateSelection();
    });

    async function checkCount(){
      const locality = (document.getElementById('locality').value || '').trim();
      const bhk = parseInt(document.getElementById('bhk').value, 10);
      const maxBudget = parseFloat(document.getElementById('budgetMax').value);

      const resultsEl = document.getElementById('results');
      const countEl = document.getElementById('propCount');
      const summaryEl = document.getElementById('summaryText');

      if(!locality || isNaN(bhk) || isNaN(maxBudget) || maxBudget <= 0){
        resultsEl.style.display = 'block';
        countEl.textContent = 'â€”';
        summaryEl.textContent = 'Please enter valid details (Budget > 0)';
        document.getElementById('r2km').textContent = 'â€”';
        document.getElementById('r2kmCount').textContent = '0 props';
        document.getElementById('r5km').textContent = 'â€”';
        document.getElementById('r5kmCount').textContent = '0 props';
        document.getElementById('inc2k').textContent = '+â‚¹2k â†’ â€”';
        document.getElementById('inc5k').textContent = '+â‚¹5k â†’ â€”';
        return;
      }

      // Show loading state
      resultsEl.style.display = 'grid';
      countEl.textContent = 'Loading...';
      summaryEl.textContent = 'Fetching property count...';
      
      const startTime = performance.now();

      try {
        // Get locality UUID from selected locality
        let localityUuid = null;
        if (selectedLocality && selectedLocality.uuid) {
          localityUuid = selectedLocality.uuid;
        } else {
          // If no selected locality, try to find it in suggestions
          const matchingLocality = suggestions.find(item => 
            item.name.toLowerCase().includes(locality.toLowerCase())
          );
          if (matchingLocality) {
            localityUuid = matchingLocality.uuid;
          }
        }

        if (!localityUuid) {
          throw new Error('Please select a locality from the dropdown.');
        }

        // Build API URL
        const targetUrl = `https://casa.housing.com/api/v1/flat/owner-count?locality_uuid=${localityUuid}&service_type=rent&bhk=${bhk}&price=${maxBudget}`;
        
        console.log('Calling API:', targetUrl);

        // Use local proxy server for reliable requests
        const proxyUrl = `/api/proxy?url=${encodeURIComponent(targetUrl)}`;
        
        console.log('Using local proxy for property count:', proxyUrl);
        
        const response = await fetch(proxyUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`Proxy request failed: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();

        if (!data) {
          throw new Error('No data received from proxy server.');
        }

        console.log('API Response:', data);

        if (data && data.data && typeof data.data.count === 'number') {
          const count = data.data.count;
          
          // Calculate response time
          const responseTime = ((performance.now() - startTime) / 1000).toFixed(2);
          
          // Update the count display
          countEl.textContent = String(count);
          summaryEl.textContent = `For ${bhk} BHK in ${locality} up to â‚¹${maxBudget} (${responseTime}s)`;

          // Calculate additional data for UI
          const near2 = [locality+" East", locality+" West", locality+" Market"];
          const near5 = [locality+" Extension", "Green Park", "Central Avenue"];

          const count2k = Math.min(300, Math.round(count * 1.05));
          const count5k = Math.min(300, Math.round(count * 1.1));

          // Simulated radius counts
          const count2km = Math.round(count * 0.4);
          const count5km = Math.round(count * 0.7);

          document.getElementById('r2km').textContent = near2.join(', ');
          document.getElementById('r2kmCount').textContent = `${count2km} props`;
          document.getElementById('r5km').textContent = near5.join(', ');
          document.getElementById('r5kmCount').textContent = `${count5km} props`;

          document.getElementById('inc2k').textContent = `+â‚¹2k â†’ ${count2k} props`;
          document.getElementById('inc5k').textContent = `+â‚¹5k â†’ ${count5k} props`;

        } else {
          throw new Error('Invalid response format from API');
        }

      } catch (error) {
        console.error('Error fetching property count:', error);
        
        // Show error state
        countEl.textContent = 'Error';
        summaryEl.textContent = `Failed to fetch data: ${error.message}`;
        
        // Reset other fields
        document.getElementById('r2km').textContent = 'â€”';
        document.getElementById('r2kmCount').textContent = '0 props';
        document.getElementById('r5km').textContent = 'â€”';
        document.getElementById('r5kmCount').textContent = '0 props';
        document.getElementById('inc2k').textContent = '+â‚¹2k â†’ â€”';
        document.getElementById('inc5k').textContent = '+â‚¹5k â†’ â€”';
      }
    }
  </script>
</body>
</html>
